<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrainingApp - MP & PM</title>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;700&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/5820e99692.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="../styles/settings.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300&display=swap" rel="stylesheet">
</head>

<body onload="showMeasurements(); showProfileSettings(); showMacronutrients()">
    <div class="background">
        <div class="bg"></div>
        <nav>
            <span class="trainingApp"><a href="mainSite.html">TrainingApp</a></span>
            <span class=navIcon><a href="mainSite.html"><i class="fas fa-utensils"></i></a></span>
            <span class=navIcon><a href="workouts.html"><i class="fas fa-dumbbell"></i></a></span>
            <span class=navIcon><a href="#"><i class="fas fa-calendar-alt"></i></a></span>
            <span class=navIcon><a href="settings.html"><i class="fas fa-cogs"></i></a></span>
        </nav>
        <main>
            <div class="content">
                <header>
                    <p>Ustawienia profilu</p>
                </header>
                <div class="buttons">
                    <div class="settingsProfileBox" id="profileSettings">
                        <table id="settingsProfilTable"></table>
                        <div class="col-12">
                            <!-- The Modal -->
                            <div id="myModal" class="modal">
                                <!-- Modal content -->
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Wyznacz cel</h5>
                                        <span class="close">
                                            &times;
                                        </span>
                                    </div>
                                    <div class="modal-body">
                                        <form>
                                            <div class="form-group">
                                                <!-- Formularz -->
                                                <label for="name">Cel</label>
                                                <input class="form-control" name="goal" type="number" id="goal" value=""
                                                    placeholder="kg" />

                                                <label for="sex">Płeć</label>
                                                <select class="form-control" name="sex" id="sex" placeholder="Płeć">
                                                    <option value="Mężczyzna">Mężczyzna</option>
                                                    <option value="Kobieta">Kobieta</option>
                                                </select>

                                                <label for="height">Wzrost</label>
                                                <input class="form-control" name="height" type="number" id="height"
                                                    value="" placeholder="cm" />

                                                <label for="weight">Waga</label>
                                                <input class="form-control" name="weight" type="number" id="weight"
                                                    value="" placeholder="kg" />

                                                <label for="dateOfBirth">Rok urodzenia</label>
                                                <input class="form-control" name="dateOfBirth" type="number"
                                                    id="dateOfBirth" min="1900" max="2099" step="1" value=""
                                                    placeholder="Rok urodzenia" />

                                                <label for="activityCoefficient">Współczynnik aktywnosci</label>
                                                <select class="form-control" id="activityCoefficient"
                                                    name="activityCoefficient">
                                                    <option value="Tryb siedzący">Tryb siedzący</option>
                                                    <option value="Aktywność niska lub umiarkowana">Aktywność niska lub
                                                        umiarkowana</option>
                                                    <option value="Aktywność wysoka">Aktywność wysoka</option>
                                                    <option value="Aktywność bardzo wysoka">Aktywność bardzo wysoka
                                                    </option>
                                                </select>
                                            </div>
                                        </form>
                                        <div id="errorBox" class="error"></div>
                                        <button class="dodaj" data-dismiss="modal" type="button">Dodaj</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button id="myBtn" class="Aktualizuj">Ustaw Cel</button>
                </div>
            </div>

            <div class="content">
                <header>
                    <p>Pomiary</p>
                </header>
                <div class="buttons">
                    <div class="settingsMeasurementsBox" id="measurements">
                        <table id="measurementTable">
                            <tr>
                                <th>Data</th>
                                <th>Waga</th>
                            </tr>
                        </table>
                        <div class="col-12">
                            <!-- The Modal -->
                            <div id="myModal1" class="modal">

                                <!-- Modal content -->
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Pomiary</h5>
                                        <span class="close1">
                                            &times;
                                        </span>
                                    </div>
                                    <div class="modal-body">
                                        <form>
                                            <div class="form-group">
                                                <!-- Formularz -->
                                                <label for="name">Data</label>
                                                <input class="form-control" name="date" type="date" id="date" />

                                                <label for="name">Waga</label>
                                                <input class="form-control" name="weight" type="number"
                                                    id="measurementWeight" value="" placeholder="kg" />
                                            </div>
                                        </form>
                                        <div id="errorBox2" class="error"></div>
                                        <button class="dodaj1" data-dismiss="modal1" type="button1">Dodaj</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button id="myBtn1" class="Aktualizuj1">Dodaj pomiary</button>
                </div>
            </div>
        </main>
        <aside>
            <section>
                <table>
                    <tr>
                        <th>Kalorie</th>
                        <th>Węglowodany</th>
                        <th>Tłuszcze</th>
                        <th>Białko</th>
                    </tr>
                    <tr id="demands">
                    </tr>
                </table>
            </section>
        </aside>
    </div>
    <!-- Insert these scripts at the bottom of the HTML, but before you use any Firebase services -->

    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-app.js"></script>

    <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
    <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-analytics.js"></script>

    <script defer src="https://www.gstatic.com/firebasejs/8.4.1/firebase-auth.js"></script>

    <script defer src="https://www.gstatic.com/firebasejs/8.4.1/firebase-database.js"></script>



    <script src="../scripts/firebase-config.js"></script>
    <script src="../scripts/mymodal.js"></script>

    <script>
        //TIMESTAMP
        function Timestamp() {
            var today = new Date();
            today =
                parseInt(today.getMonth() + 1) +
                "-" +
                today.getDate() +
                "-" +
                today.getFullYear() +
                "-" +
                today.getHours() +
                "-" +
                today.getMinutes() +
                "-" +
                today.getSeconds();
            console.log(today);

            return today;
        }

        function showMeasurements() {
            var database = firebase.database();
            var user = firebase.auth().currentUser;

            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    // User logged in already or has just logged in.
                    user_id = user.uid;
                    const dbRef = firebase.database().ref();
                    dbRef.child("users").child(user_id).child("measurements").get().then((snapshot) => {
                        if (snapshot.exists()) {
                            measurments = Object.values(snapshot.val());
                            addItemsTable(measurments);
                        } else {
                            console.log("No data available");
                        }
                    }).catch((error) => {
                        console.error(error);
                    });
                } else {
                    console.log("uzytkownik niezalogowany");
                }
            });
        }

        function addItemsTable(data) {
            //pokazywanie danych w to do
            var getTable = document.getElementById("measurementTable");
            var TextForDateRow;
            var TextForWeightRow;
            var createTr;
            var CreateDateRow;
            var CreateWeightRow;
            data.forEach((ex) => {
                createTr = document.createElement("TR"); // Create a <li> node
                CreateDateRow = document.createElement("TD");
                CreateWeightRow = document.createElement("TD");

                CreateDateRow.setAttribute("id", ex.date);
                CreateWeightRow.setAttribute("id", ex.weight);

                TextForDateRow = document.createTextNode(ex.date);
                TextForWeightRow = document.createTextNode(ex.weight);

                CreateDateRow.appendChild(TextForDateRow);
                CreateWeightRow.appendChild(TextForWeightRow);
                getTable.appendChild(createTr);
                getTable.appendChild(CreateDateRow);
                getTable.appendChild(CreateWeightRow);
            });
        }

        function updateSettings() {
            var database = firebase.database();
            let sex = document.getElementById("sex").value;
            let height = document.getElementById("height").value;
            let weight = document.getElementById("weight").value;
            let dateOfBirth = document.getElementById("dateOfBirth").value;
            let goal = document.getElementById("goal").value;
            let activityCoefficient = document.getElementById("activityCoefficient").value;
            var getErrorBox = document.getElementById("errorBox");
            var user = firebase.auth().currentUser;


            if (sex == "" || height == "" || weight == "" || dateOfBirth == "" ||
                activityCoefficient == "" ||
                goal == "") {
                getErrorBox.innerHTML = "Uzupełnij wszystkie dane";
            } else {
                firebase.auth().onAuthStateChanged((user) => {
                    if (user) {
                        // User logged in already or has just logged in.
                        console.log(user.uid);
                        user_id = user.uid;
                        firebase.database().ref('users/' + user_id + '/userInfo').set({
                            sex: sex,
                            height: height,
                            weight: weight,
                            dateOfBirth: dateOfBirth,
                            goal: goal,
                            activityCoefficient: activityCoefficient,
                        });
                        firebase.database().ref('users/' + user_id + '/macronutrients').set({
                            ADailyRequirement: calculateCPM(),
                            proteins: ((weight * 1.5) | 0),
                            fats: (((calculateCPM() * 0.25) / 9) | 0),
                            carbohydrates: (((calculateCPM() * 0.55) / 4) | 0),
                        });
                    } else {
                        console.log("uzytkownik niezalogowany");
                    }
                });
                window.location.reload(true);
            }
        }

        function addMeasurement() {
            var database = firebase.database();
            let date = document.getElementById("date").value;
            let weight = document.getElementById("measurementWeight").value;
            var user = firebase.auth().currentUser;
            let id = Timestamp();
            var getErrorBox = document.getElementById("errorBox2");

            if (date == "" || weight == "") {
                getErrorBox.innerHTML = "Uzupełnij wszystkie dane";
            } else {
                firebase
                    .database()
                    .ref("/users/" + user_id + "/measurements/")
                    .update({
                        [id]: {
                            date: date,
                            weight: weight,
                        },
                    })
                    .then(() => console.log("Data updated."))
                    .catch((error) => {
                        console.error(error);
                    });
                window.location.reload(true);
            }
        }

        function calculateCPM() {
            let sex = document.getElementById("sex").value;
            let height = document.getElementById("height").value;
            let weight = document.getElementById("weight").value;
            let dateOfBirth = document.getElementById("dateOfBirth").value;
            let goal = document.getElementById("goal").value;
            let activityCoefficient = document.getElementById("activityCoefficient").value;
            var getErrorBox = document.getElementById("errorBox");
            var user = firebase.auth().currentUser;

            var today = new Date();
            var getYear = today.getFullYear();
            let age = getYear - dateOfBirth;

            let dailyRequirement;

            if (sex == "Mężczyzna") {
                dailyRequirement = (66 + (13.7 * weight) + (5 * height) - (6.76 * age));
                dailyRequirement = parseInt(dailyRequirement, 10);
                switch (activityCoefficient) {
                    case 'Tryb siedzący':
                        if (goal > weight) {
                            return parseInt(dailyRequirement * 1.2, 10) + 200;
                            break;
                        } else {
                            return parseInt(dailyRequirement * 1.2, 10) - 200;
                            break;
                        }

                        case 'Aktywność niska lub umiarkowana':
                            if (goal > weight) {
                                return parseInt(dailyRequirement * 1.3, 10) + 200;
                                break;
                            } else {
                                return parseInt(dailyRequirement * 1.3, 10) - 200;
                                break;
                            }
                            case 'Aktywność wysoka':
                                if (goal > weight) {
                                    return parseInt(dailyRequirement * 1.5, 10) + 200;
                                    break;
                                } else {
                                    return parseInt(dailyRequirement * 1.5, 10) - 200;
                                    break;
                                }
                                case 'Aktywność bardzo wysoka':
                                    if (goal > weight) {
                                        return parseInt(dailyRequirement * 2, 10) + 200;
                                        break;
                                    } else {
                                        return parseInt(dailyRequirement * 2, 10) - 200;
                                        break;
                                    }
                }
            } else {
                dailyRequirement = (665 + (9.6 * weight) + (1.8 * height) - (4.7 * age));
                dailyRequirement = parseInt(dailyRequirement, 10);
                switch (activityCoefficient) {
                    case 'Tryb siedzący':
                        if (goal > weight) {
                            return parseInt(dailyRequirement * 1.2, 10) + 200;
                            break;
                        } else {
                            return parseInt(dailyRequirement * 1.2, 10) - 200;
                            break;
                        }
                        case 'Aktywność niska lub umiarkowana':
                            if (goal > weight) {
                                return parseInt(dailyRequirement * 1.3, 10) + 200;
                                break;
                            } else {
                                return parseInt(dailyRequirement * 1.3, 10) - 200;
                                break;
                            }
                            case 'Aktywność wysoka':
                                if (goal > weight) {
                                    return parseInt(dailyRequirement * 1.5, 10) + 200;
                                    break;
                                } else {
                                    return parseInt(dailyRequirement * 1.5, 10) - 200;
                                    break;
                                }
                                case 'Aktywność bardzo wysoka':
                                    if (goal > weight) {
                                        return parseInt(dailyRequirement * 2, 10) + 200;
                                        break;
                                    } else {
                                        return parseInt(dailyRequirement * 2, 10) - 200;
                                        break;
                                    }
                }
            }

        }
        /* -----------------------------------------------------------------*/

        function showProfileSettings() {
            var database = firebase.database();
            var user = firebase.auth().currentUser;

            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    const dbRef = firebase.database().ref();
                    dbRef.child("users").child(user_id).child("userInfo").get().then((
                        snapshot) => {
                        if (snapshot.exists()) {
                            userInfo = Object.values(snapshot.val());
                            addItemToTableSettings(userInfo);
                        } else {
                            console.log("No data available");
                        }
                    }).catch((error) => {
                        console.error(error);
                    });
                } else {
                    console.log("uzytkownik niezalogowany");
                }
            });
        }

        function addItemToTableSettings(data) {
            var getTable = document.getElementById("settingsProfilTable")

            var TextForDateRow;
            var TextForWeightRow;

            var createTr;

            var CreateFirstRow;
            var CreateSecondRow;
            counter = 0;


            data.forEach((ex) => {

                namesForTableHead = ["Płeć", "Wzrost", "Waga", "Rok urodzenia", "Cel",
                    "Współczynnik aktywności", "Dzienne zapotrzebowanie"
                ];
                namesForTableElements = [4, 3, 5, 1, 2, 0];
                createTr = document.createElement("TR"); // Create a <li> node
                CreateFirstRow = document.createElement("TD");
                CreateSecondRow = document.createElement("TD");

                CreateFirstRow.setAttribute("id", namesForTableHead[counter]);
                // CreateSecondRow.setAttribute("id", ex.name);

                TextForDateRow = document.createTextNode(namesForTableHead[counter]);
                TextForWeightRow = document.createTextNode(data[namesForTableElements[counter]]);

                CreateFirstRow.appendChild(TextForDateRow);
                CreateSecondRow.appendChild(TextForWeightRow);


                getTable.appendChild(createTr);
                getTable.appendChild(CreateFirstRow);
                getTable.appendChild(CreateSecondRow);
                counter++;
            });
        }


        /* ------------------------------------------------------------------------ */
        function showMacronutrients() {
            var database = firebase.database();
            var user = firebase.auth().currentUser;

            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    const dbRef = firebase.database().ref();
                    dbRef.child("users").child(user_id).child("macronutrients").get().then((
                        snapshot) => {
                        if (snapshot.exists()) {
                            userInfo = Object.values(snapshot.val());
                            addItemToTableAside(userInfo);
                        } else {
                            console.log("No data available");
                        }
                    }).catch((error) => {
                        console.error(error);
                    });
                } else {
                    console.log("uzytkownik niezalogowany");
                }
            });
        }

        function addItemToTableAside(data) {
            var getTable = document.getElementById("demands")
            var createTd;
            var CreateDiv;
            var TextForRow;
            var CreateSecondRow;



            data.forEach((ex) => {

                createTd = document.createElement("TD");
                CreateDiv = document.createElement("div");

                TextForRow = document.createTextNode(ex);


                createTd.appendChild(CreateDiv.appendChild(TextForRow));
                getTable.appendChild(createTd);

            });
        }
    </script>
</body>

</html>